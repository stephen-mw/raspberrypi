---
- hosts: all
  become: yes
  tasks:
    - name: install packages
      apt:
        update_cache: true
        state: latest
        name:
          - chrony
          - curl
          - git
          - lsof
          - python3-pip
          - rng-tools
          - rsyslog
          - screen
          - software-properties-common
          - ssh-import-id
          - unp
          - vim
          - wget
    - name: remove apparmor
      apt:
        state: absent
        name:
          - apparmor
    - name: Remove popularity contest
      ansible.builtin.file:
        path: /etc/cron.daily/popularity-contest
        state: absent
    - name: install python packages
      pip:
        name:
          - black
          - isort
    - name: install golang
      script: install_golang
      environment:
        ARCH: "{{ ansible_architecture }}"
        VERSION: "1.20.2"
      script: install_golang
    - name: Add sudo/adm group
      ansible.builtin.group:
        name: "{{ item }}"
        state: present
        system: true
      loop:
        - adm
        - sudo
    - name: Add chrony sources
      when: '"greenhouse*" != "${ansible_hostname}"'
      copy:
        dest: /etc/chrony/sources.d/local.sources
        owner: root
        mode: 0644
        content: |
          # Local NTP backups
          server 10.10.10.12 iburst
          server 10.10.10.10 iburst
          pool time.google.com iburst maxsources 3
          pool pool.ntp.org iburst maxsources 3
    - name: Add me
      user:
        name: smw
        comment: Stephen Wood
        groups: sudo, adm
        shell: /bin/bash
    - name: add github known host key
      ansible.builtin.known_hosts:
        name: github.com
        key: github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
        path: /etc/ssh/ssh_known_hosts
        state: present
    - name: add github to authorized_keys
      run_once: true
      shell: ssh-keyscan github.com >> /etc/ssh/ssh_known_hosts
    - name: Set authorized keys for smw
      ansible.posix.authorized_key:
        user: smw
        state: present
        key: https://github.com/stephen-mw.keys
    - name: update smw keys
      shell: ssh-import-id -o ~smw/.ssh/authorized_keys gh:stephen-mw
      run_once: true
    - name: setup root user
      shell: cp -r /etc/skel/. /root/
      run_once: true
    - name: setup sudoers
      copy:
        dest: /etc/sudoers.d/01smw
        content: |
            smw ALL=(ALL) NOPASSWD: ALL
            # Allow sudo to keep using agent forwarding
            Defaults    env_keep+=SSH_AUTH_SOCK
    - name: custom shell
      copy:
        src: ../assets/profile.sh
        dest: /etc/profile.d/custom.sh
    - name: setup vim
      copy:
        src: ../assets/vimrc
        dest: /etc/vim/vimrc.local
    - name: vim default
      shell: update-alternatives --set editor /usr/bin/vim.basic
    - name: setup secret envs file in /etc/profile.d/secrets.sh
      copy:
        dest: /etc/profile.d/secrets.sh
        src: rpirc
    - name: setup cron
      copy:
        dest: /etc/cron.d/ansible
        owner: root
        mode: 0644
        content: |
          MAILTO=contact.stephen.wood@gmail.com
          BASH_ENV=/etc/profile.d/secrets.sh
          SHELL=/usr/bin/bash
          @daily smw /usr/bin/ssh-import-id gh:stephen-mw
          @restart smw /usr/bin/ssh-import-id gh:stephen-mw
    - name: lock down sshd
      copy:
        dest: /etc/ssh/sshd_config.d/ansible
        owner: root
        mode: 0644
        content: |
          Include /etc/ssh/sshd_config.d/*.conf
          AllowUsers smw
          PasswordAuthentication no
          UseDNS no
          X11Forwarding yes
          X11UseLocalhost no
          AddressFamily inet
